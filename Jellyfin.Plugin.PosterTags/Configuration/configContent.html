<style>
            #PosterTagsConfigPage { box-sizing: border-box; position: relative; pointer-events: auto; z-index: 1; }
            .postertags-page { max-width: none; margin: 0; padding: 2rem 2rem 3rem 2.5rem; color: #e0e0e0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; font-size: 14px; line-height: 1.5; }
            .postertags-layout { display: flex; gap: 2rem; align-items: flex-start; max-width: 1200px; margin: 0 auto; }
            .postertags-main { flex: 1; min-width: 0; max-width: 720px; }
            .postertags-preview-sidebar { width: 320px; flex-shrink: 0; position: sticky; top: 0; }
            .postertags-preview-sidebar .sectionTitle { margin-top: 0; }
            .postertags-page .postertags-version { margin: 0 0 1rem; font-size: 0.8rem; color: #888; }
            .postertags-page .sectionTitleContainer { margin-bottom: 0.5rem; }
            .postertags-page .sectionTitle { font-size: 1.5rem; font-weight: 600; margin: 0; color: #fff; letter-spacing: -0.02em; }
            .postertags-page .sectionContentContainer { background: rgba(255,255,255,0.05); border-radius: 8px; padding: 1.5rem; margin-top: 1rem; border: 1px solid rgba(255,255,255,0.08); }
            .postertags-page .fieldDescription { color: #a0a0a0; font-size: 0.9rem; margin: 0.35rem 0 1rem; line-height: 1.45; }
            .postertags-page h3.sectionTitle { font-size: 1rem; font-weight: 600; color: #e8e8e8; margin: 1.5rem 0 0.5rem; padding-bottom: 0.25rem; }
            .postertags-page .selectContainer, .postertags-page .inputContainer, .postertags-page .checkboxContainer { margin-bottom: 0.5rem; }
            .postertags-page .inputLabel, .postertags-page .checkboxLabel { font-weight: 500; color: #e0e0e0; }
            .postertags-page select.select, .postertags-page .inputControl { background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.15); border-radius: 4px; color: #e0e0e0; padding: 0.5rem 0.65rem; min-height: 36px; }
            .postertags-page select.select:focus, .postertags-page .inputControl:focus { outline: none; border-color: #00a4dc; box-shadow: 0 0 0 2px rgba(0,164,220,0.25); }
            .postertags-page .btn { padding: 0.5rem 1rem; border-radius: 4px; font-weight: 500; cursor: pointer; border: none; }
            .postertags-page .btn-primary { background: #00a4dc; color: #fff; }
            .postertags-page .btn-primary:hover { background: #0092c4; }
            .postertags-page .btn-secondary { background: rgba(255,255,255,0.12); color: #e0e0e0; }
            .postertags-page .btn-secondary:hover { background: rgba(255,255,255,0.18); }
            .postertags-page a { color: #00a4dc; text-decoration: none; }
            .postertags-page a:hover { text-decoration: underline; }
            #PreviewContainer { border-radius: 8px; border: 1px solid rgba(255,255,255,0.08); }
            .postertags-preview-placeholder { display: flex; align-items: center; justify-content: center; min-height: 200px; padding: 1.5rem; color: #888; font-size: 0.95rem; text-align: center; background: rgba(0,0,0,0.2); border-radius: 4px; }
            #PreviewImageWrap.has-image .postertags-preview-placeholder { display: none; }
            #PreviewImageWrap .postertags-preview-img { display: none; max-width: 300px; max-height: 450px; border-radius: 4px; min-height: 200px; background: rgba(0,0,0,0.3); }
            #PreviewImageWrap.has-image .postertags-preview-img { display: block; }
            .library-cards-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 0.75rem; margin: 0.5rem 0 1rem; }
            .library-card { display: flex; align-items: center; gap: 0.5rem; padding: 0.75rem 1rem; background: rgba(255,255,255,0.08); border: 1px solid rgba(255,255,255,0.15); border-radius: 8px; cursor: pointer; transition: background 0.15s, border-color 0.15s; pointer-events: auto; user-select: none; -webkit-user-select: none; }
            .library-card:hover { background: rgba(255,255,255,0.12); border-color: rgba(255,255,255,0.25); }
            .library-card input[type="checkbox"] { margin: 0; flex-shrink: 0; cursor: pointer; pointer-events: auto; }
            .library-card .library-name { font-weight: 500; color: #e0e0e0; word-break: break-word; }
        </style>
        <div id="PosterTagsConfigPage" class="configPage postertags-page" style="min-height:200px;">
        <p id="PosterTagsVersion" class="postertags-version">Poster Tags plugin version: <strong>{{POSTERTAGS_VERSION}}</strong></p>
        <script>
            (function(){
                try {
                    var v = '{{POSTERTAGS_VERSION}}';
                    if (window.console && window.console.log) {
                        window.console.log('[Poster Tags] Plugin version:', v);
                    }
                } catch (e) { if (window.console) window.console.log('[Poster Tags] log error', e); }
            })();
        </script>
        <div class="sectionTitleContainer flex align-items-center">
            <h2 class="sectionTitle">Poster Tags — Settings</h2>
        </div>
        <div class="postertags-layout">
        <div class="postertags-main">
        <div class="sectionContentContainer sectionContentContainerBorderNoPadding" style="border: none;">
            <form id="PosterTagsConfigForm">
                <p class="fieldDescription" style="margin-bottom: 1.5rem;">
                    Configure how tags are embedded on library posters. With <strong>Apply automatically after library scan</strong> enabled, new movies and series get tags without running a task. You can also run the <strong>Add Poster Tags</strong> scheduled task (Dashboard → Scheduled Tasks) to apply to existing items.
                </p>

                <h3 class="sectionTitle" style="font-size: 1em; margin: 1em 0 0.5em;">Libraries to process</h3>
                <p class="fieldDescription" style="margin-bottom: 0.5rem;">Select which libraries to add poster tags to. Leave all unchecked to process all libraries.</p>
                <div id="LibraryCardsContainer" class="library-cards-grid"></div>

                <h3 class="sectionTitle" style="font-size: 1em; margin: 1.5em 0 0.5em;">Badge position &amp; shape</h3>
                <div class="selectContainer">
                    <label class="inputLabel inputLabelUnified" for="BadgePosition">Position on poster</label>
                    <select id="BadgePosition" name="BadgePosition" class="select flex align-items-center">
                        <option value="TopLeft">Top Left</option>
                        <option value="TopCenter">Top Center</option>
                        <option value="TopRight">Top Right</option>
                        <option value="BottomLeft">Bottom Left</option>
                        <option value="BottomCenter">Bottom Center</option>
                        <option value="BottomRight">Bottom Right</option>
                    </select>
                </div>
                <div class="inputContainer" style="margin-top: 0.5em;">
                    <label class="inputLabel inputLabelUnified" for="TagCurvature">Tag edge curvature</label>
                    <input type="range" id="TagCurvature" name="TagCurvature" min="0" max="100" value="0" style="width: 12em; vertical-align: middle;" />
                    <span id="TagCurvatureLabel" style="margin-left: 0.5em;">0 — Rectangle</span>
                    <div class="fieldDescription">0 = sharp rectangle, 100 = pill. Applies to main badges and custom tag.</div>
                </div>

                <h3 class="sectionTitle" style="font-size: 1em; margin: 1.5em 0 0.5em;">Resolution badge</h3>
                <div class="checkboxContainer checkboxContainer-withDescription">
                    <label class="checkboxLabel">
                        <input type="checkbox" id="ShowQuality" />
                        <span>Show resolution badge</span>
                    </label>
                    <div class="fieldDescription">Display quality tier (SD / HD / FHD / UHD or 480p / 720p / 1080p / 4K).</div>
                </div>
                <div class="selectContainer" style="margin-top: 0.5em;">
                    <label class="inputLabel inputLabelUnified" for="UseLetterResolution">Resolution format</label>
                    <select id="UseLetterResolution" name="UseLetterResolution" class="select flex align-items-center">
                        <option value="true">Letters (SD, HD, FHD, UHD)</option>
                        <option value="false">Numbered (480p, 720p, 1080p, 4K)</option>
                    </select>
                    <div class="fieldDescription">SD = below 720p, HD = 720p, FHD = 1080p, UHD = 4K.</div>
                </div>
                <div class="checkboxContainer checkboxContainer-withDescription" style="margin-top: 0.5em;">
                    <label class="checkboxLabel">
                        <input type="checkbox" id="Show4K" />
                        <span>Include 4K / UHD in resolution badge</span>
                    </label>
                </div>
                <div class="checkboxContainer checkboxContainer-withDescription">
                    <label class="checkboxLabel">
                        <input type="checkbox" id="ShowHD" />
                        <span>Include HD / FHD in resolution badge</span>
                    </label>
                </div>

                <h3 class="sectionTitle" style="font-size: 1em; margin: 1.5em 0 0.5em;">External ratings (API)</h3>
                <div class="checkboxContainer checkboxContainer-withDescription">
                    <label class="checkboxLabel">
                        <input type="checkbox" id="UseExternalRatings" />
                        <span>Use external API for IMDb &amp; Rotten Tomatoes</span>
                    </label>
                    <div class="fieldDescription">When enabled and API keys are set, fetch ratings from MDBList (and TMDB) instead of Jellyfin metadata.</div>
                </div>
                <div class="inputContainer">
                    <label class="inputLabel inputLabelUnified" for="MdbListApiKey">MDBList API key</label>
                    <input type="password" id="MdbListApiKey" class="inputControl" autocomplete="off" placeholder="Optional" />
                    <div class="fieldDescription">Get a key at <a href="https://mdblist.com" target="_blank" rel="noopener">mdblist.com</a>. Used for IMDb, Rotten Tomatoes, TMDB, Letterboxd ratings.</div>
                </div>
                <div class="inputContainer" style="margin-top: 0.5em;">
                    <label class="inputLabel inputLabelUnified" for="TmdbApiKey">TMDB API key (optional)</label>
                    <input type="password" id="TmdbApiKey" class="inputControl" autocomplete="off" placeholder="Optional" />
                    <div class="fieldDescription">Get a key at <a href="https://www.themoviedb.org/settings/api" target="_blank" rel="noopener">themoviedb.org</a>. For episode/season ratings.</div>
                </div>

                <h3 class="sectionTitle" style="font-size: 1em; margin: 1.5em 0 0.5em;">Other tags</h3>
                <div class="checkboxContainer checkboxContainer-withDescription">
                    <label class="checkboxLabel">
                        <input type="checkbox" id="ShowAudioLanguageFlags" />
                        <span>Show audio language flags</span>
                    </label>
                    <div class="fieldDescription">Display country flags (e.g. ­čç║­čçŞ ­čçČ­čçž) for audio languages.</div>
                </div>
                <div class="checkboxContainer checkboxContainer-withDescription">
                    <label class="checkboxLabel">
                        <input type="checkbox" id="SkipItemsWithNoAudioLanguage" />
                        <span>Skip items with no known audio language</span>
                    </label>
                    <div class="fieldDescription">When audio flags are enabled, do not add poster tags to items with unknown or missing audio language.</div>
                </div>
                <div class="checkboxContainer checkboxContainer-withDescription">
                    <label class="checkboxLabel">
                        <input type="checkbox" id="ShowImdbRating" />
                        <span>Show IMDb rating</span>
                    </label>
                    <div class="fieldDescription">From external API (if enabled) or Jellyfin community rating.</div>
                </div>
                <div class="checkboxContainer checkboxContainer-withDescription">
                    <label class="checkboxLabel">
                        <input type="checkbox" id="ShowRottenTomatoes" />
                        <span>Show Rotten Tomatoes rating</span>
                    </label>
                    <div class="fieldDescription">From external API (if enabled) or Jellyfin critic rating.</div>
                </div>

                <h3 class="sectionTitle" style="font-size: 1em; margin: 1.5em 0 0.5em;">Video &amp; audio quality</h3>
                <div class="checkboxContainer checkboxContainer-withDescription">
                    <label class="checkboxLabel">
                        <input type="checkbox" id="ShowHDR" />
                        <span>Show HDR badge</span>
                    </label>
                    <div class="fieldDescription">Display HDR type: HDR10, HDR10+, Dolby Vision, or HLG when detected.</div>
                </div>
                <div class="checkboxContainer checkboxContainer-withDescription">
                    <label class="checkboxLabel">
                        <input type="checkbox" id="ShowDolbyAtmos" />
                        <span>Show Dolby Atmos</span>
                    </label>
                    <div class="fieldDescription">Show Dolby Atmos badge when the audio track has Atmos.</div>
                </div>
                <div class="checkboxContainer checkboxContainer-withDescription">
                    <label class="checkboxLabel">
                        <input type="checkbox" id="ShowDtsX" />
                        <span>Show DTS:X</span>
                    </label>
                    <div class="fieldDescription">Show DTS:X badge when the audio track has DTS:X.</div>
                </div>

                <h3 class="sectionTitle" style="font-size: 1em; margin: 1.5em 0 0.5em;">Custom tag</h3>
                <div class="checkboxContainer checkboxContainer-withDescription">
                    <label class="checkboxLabel">
                        <input type="checkbox" id="CustomTagEnabled" />
                        <span>Show custom text tag on poster</span>
                    </label>
                    <div class="fieldDescription">Display a custom label (e.g. NEW, FAVORITE) at a chosen position.</div>
                </div>
                <div class="inputContainer" style="margin-top: 0.5em;">
                    <label class="inputLabel inputLabelUnified" for="CustomTagText">Custom tag text</label>
                    <input type="text" id="CustomTagText" class="inputControl" placeholder="e.g. NEW" maxlength="32" />
                </div>
                <div class="selectContainer" style="margin-top: 0.5em;">
                    <label class="inputLabel inputLabelUnified" for="CustomTagPosition">Custom tag position</label>
                    <select id="CustomTagPosition" name="CustomTagPosition" class="select flex align-items-center">
                        <option value="TopLeft">Top Left</option>
                        <option value="TopCenter">Top Center</option>
                        <option value="TopRight">Top Right</option>
                        <option value="BottomLeft">Bottom Left</option>
                        <option value="BottomCenter">Bottom Center</option>
                        <option value="BottomRight">Bottom Right</option>
                    </select>
                </div>

                <h3 class="sectionTitle" style="font-size: 1em; margin: 1.5em 0 0.5em;">Automation</h3>
                <div class="checkboxContainer checkboxContainer-withDescription">
                    <label class="checkboxLabel">
                        <input type="checkbox" id="AutoApplyOnLibraryScan" />
                        <span>Apply poster tags automatically when library scan completes</span>
                    </label>
                    <div class="fieldDescription">When enabled, new and updated items get poster tags without running the scheduled task. Works with real-time library scans (e.g. when new movies are added).</div>
                </div>

                <div style="margin-top: 2rem; padding-top: 1rem;">
                    <button type="submit" class="btn btn-primary">Save</button>
                </div>
            </form>
        </div>
        </div>
        <aside class="postertags-preview-sidebar">
                <h3 class="sectionTitle" style="font-size: 1em; margin: 0 0 0.5em;">Live preview</h3>
                <p class="fieldDescription" style="margin-bottom: 0.5rem;">Random movie/series from selected libraries. Same logic as applied tags.</p>
                <div id="PreviewContainer" style="margin: 0; padding: 1em; background: rgba(0,0,0,0.2); border-radius: 8px; border: 1px solid rgba(255,255,255,0.08);">
                    <div id="PreviewLabel" style="margin-bottom: 0.5em; font-weight: 500;">Using: —</div>
                    <div id="PreviewImageWrap" style="position: relative; display: inline-block; min-height: 200px; width: 100%;">
                        <div id="PreviewSpinner" class="posterTagsSpinner" style="display: none; position: absolute; left: 50%; top: 50%; transform: translate(-50%,-50%); width: 48px; height: 48px; border: 4px solid rgba(255,255,255,0.3); border-top-color: #fff; border-radius: 50%; animation: posterTagsSpin 0.8s linear infinite;"></div>
                        <div id="PreviewPlaceholder" class="postertags-preview-placeholder">Nothing to preview. Please click the random button below.</div>
                        <img id="PreviewImage" class="postertags-preview-img" alt="Preview" />
                    </div>
                    <div style="margin-top: 0.75em;">
                        <button type="button" id="RefreshPreviewBtn" class="btn btn-secondary">Pick random &amp; refresh</button>
                        <span id="PreviewStatus" style="display: block; margin-top: 0.35em; font-size: 0.9em;"></span>
                    </div>
                </div>
        </aside>
        </div>
        <style>
            @keyframes posterTagsSpin { to { transform: translate(-50%,-50%) rotate(360deg); } }
            .posterTagsSpinner.isLoading { display: block !important; }
        </style>
        </div>
    <script>
        (function () {
            if (typeof window.ApiClient === 'undefined' && window.parent && typeof window.parent.ApiClient !== 'undefined') {
                window.ApiClient = window.parent.ApiClient;
                window.Dashboard = window.parent.Dashboard;
            }
        })();
        try { if (window.console) window.console.log('[Poster Tags] ApiClient=', typeof ApiClient, 'Dashboard=', typeof Dashboard); } catch (e) {}
        (function () {
            if (typeof ApiClient === 'undefined' || typeof Dashboard === 'undefined') {
                var msg = document.createElement('p');
                msg.className = 'fieldDescription';
                msg.style.cssText = 'color:#e74c3c;margin:1em;';
                msg.textContent = 'Poster Tags: Jellyfin API (ApiClient/Dashboard) not available. Open Settings from Dashboard → Plugins → Poster Tags.';
                var root = document.querySelector('#PosterTagsConfigPage');
                if (root && root.firstChild) root.insertBefore(msg, root.firstChild);
                else if (root) root.appendChild(msg);
                return;
            }
        })();
        var PosterTagsConfig = {
            pluginUniqueId: 'a7b8c9d0-e1f2-3456-7890-abcdef123456',
            previewBase: 'Plugins/PosterTags',
            previewItemId: null,
            previewItemName: '',
            previewDebounce: null
        };

        function getAuthHeaders() {
            var token = typeof ApiClient !== 'undefined' ? ApiClient.accessToken() : null;
            return token ? { 'X-Emby-Token': token } : {};
        }

        function buildConfigFromForm() {
            var selectedIds = [];
            document.querySelectorAll('input[name="LibraryIds"]:checked').forEach(function (cb) { selectedIds.push(cb.value); });
            return {
                SelectedLibraryIds: selectedIds,
                Show4K: document.querySelector('#Show4K').checked,
                ShowHD: document.querySelector('#ShowHD').checked,
                ShowQuality: document.querySelector('#ShowQuality').checked,
                ShowAudioLanguageFlags: document.querySelector('#ShowAudioLanguageFlags').checked,
                SkipItemsWithNoAudioLanguage: document.querySelector('#SkipItemsWithNoAudioLanguage').checked,
                ShowImdbRating: document.querySelector('#ShowImdbRating').checked,
                ShowRottenTomatoes: document.querySelector('#ShowRottenTomatoes').checked,
                BadgePosition: document.querySelector('#BadgePosition').value || 'BottomLeft',
                UseLetterResolution: document.querySelector('#UseLetterResolution').value === 'true',
                UseExternalRatings: document.querySelector('#UseExternalRatings').checked,
                MdbListApiKey: (document.querySelector('#MdbListApiKey').value || '').trim(),
                TmdbApiKey: (document.querySelector('#TmdbApiKey').value || '').trim(),
                CustomTagEnabled: document.querySelector('#CustomTagEnabled').checked,
                CustomTagText: (document.querySelector('#CustomTagText').value || '').trim(),
                CustomTagPosition: document.querySelector('#CustomTagPosition').value || 'TopLeft',
                TagCurvature: Math.min(100, Math.max(0, parseInt(document.querySelector('#TagCurvature').value, 10) || 0)),
                AutoApplyOnLibraryScan: document.querySelector('#AutoApplyOnLibraryScan').checked,
                ShowHDR: document.querySelector('#ShowHDR').checked,
                ShowDolbyAtmos: document.querySelector('#ShowDolbyAtmos').checked,
                ShowDtsX: document.querySelector('#ShowDtsX').checked
            };
        }

        function setPreviewStatus(msg, isError) {
            var el = document.querySelector('#PreviewStatus');
            if (!el) return;
            el.textContent = msg || '';
            el.style.color = isError ? '#e74c3c' : '';
        }

        function setPreviewLoading(loading) {
            var spinner = document.querySelector('#PreviewSpinner');
            var btn = document.querySelector('#RefreshPreviewBtn');
            if (spinner) spinner.classList.toggle('isLoading', !!loading);
            if (btn) btn.disabled = !!loading;
        }

        function setPreviewImageBlob(blob) {
            var img = document.querySelector('#PreviewImage');
            var wrap = document.querySelector('#PreviewImageWrap');
            if (!img || !wrap) return;
            if (img.src && img.src.indexOf('blob:') === 0) URL.revokeObjectURL(img.src);
            img.src = blob ? URL.createObjectURL(blob) : '';
            wrap.classList.toggle('has-image', !!blob);
        }

        function loadPreviewImage(useLiveConfig) {
            var img = document.querySelector('#PreviewImage');
            var label = document.querySelector('#PreviewLabel');
            if (!img || !label) return;
            var itemId = PosterTagsConfig.previewItemId;
            if (!itemId) {
                setPreviewStatus('Pick random first or save to load preview.', true);
                return;
            }
            setPreviewLoading(true);
            setPreviewStatus('Loading…');
            var url = ApiClient.getUrl(PosterTagsConfig.previewBase + '/Preview?itemId=' + encodeURIComponent(itemId));
            var opts = { headers: getAuthHeaders(), credentials: 'include' };
            function done(err) {
                setPreviewLoading(false);
                if (err) setPreviewStatus(err, true);
                else setPreviewStatus('');
            }
            if (useLiveConfig) {
                var config = buildConfigFromForm();
                fetch(ApiClient.getUrl(PosterTagsConfig.previewBase + '/Preview'), {
                    method: 'POST',
                    headers: Object.assign({ 'Content-Type': 'application/json' }, getAuthHeaders()),
                    credentials: 'include',
                    body: JSON.stringify({ ItemId: itemId, Config: config })
                }).then(function (r) {
                    if (!r.ok) throw new Error(r.statusText);
                    return r.blob();
                }).then(function (blob) {
                    setPreviewImageBlob(blob);
                    label.textContent = 'Using: ' + (PosterTagsConfig.previewItemName || itemId);
                    done();
                }).catch(function () {
                    done('Preview failed.');
                });
                return;
            }
            fetch(url, opts).then(function (r) {
                if (!r.ok) throw new Error(r.statusText);
                return r.blob();
            }).then(function (blob) {
                setPreviewImageBlob(blob);
                label.textContent = 'Using: ' + (PosterTagsConfig.previewItemName || itemId);
                done();
            }).catch(function () {
                done('Preview failed.');
            });
        }

        function fetchPreviewItemAndImage() {
            setPreviewLoading(true);
            setPreviewStatus('Loading…');
            setPreviewImageBlob(null);
            document.querySelector('#PreviewLabel').textContent = 'Using: —';
            var url = ApiClient.getUrl(PosterTagsConfig.previewBase + '/PreviewItem');
            fetch(url, { headers: getAuthHeaders(), credentials: 'include' })
                .then(function (r) { return r.ok ? r.json() : Promise.reject(new Error(r.statusText)); })
                .then(function (data) {
                    PosterTagsConfig.previewItemId = data.Id;
                    PosterTagsConfig.previewItemName = data.Name || '';
                    document.querySelector('#PreviewLabel').textContent = 'Using: ' + (data.Name || data.Id) + '…';
                    return fetch(ApiClient.getUrl(PosterTagsConfig.previewBase + '/Preview?itemId=' + encodeURIComponent(data.Id)), { headers: getAuthHeaders(), credentials: 'include' });
                })
                .then(function (r) {
                    if (!r.ok) throw new Error(r.statusText);
                    return r.blob();
                })
                .then(function (blob) {
                    setPreviewImageBlob(blob);
                    setPreviewStatus('');
                    setPreviewLoading(false);
                })
                .catch(function () {
                    setPreviewStatus('No items with posters in selected libraries.', true);
                    setPreviewLoading(false);
                });
        }

        var pageEl = document.querySelector('#PosterTagsConfigPage');
        if (pageEl && typeof ApiClient !== 'undefined' && typeof Dashboard !== 'undefined') {
            pageEl.addEventListener('pageshow', function () {
                Dashboard.showLoadingMsg();
                ApiClient.getPluginConfiguration(PosterTagsConfig.pluginUniqueId).then(function (config) {
                if (config) {
                    document.querySelector('#Show4K').checked = config.Show4K !== false;
                    document.querySelector('#ShowHD').checked = config.ShowHD !== false;
                    document.querySelector('#ShowQuality').checked = config.ShowQuality !== false;
                    document.querySelector('#ShowAudioLanguageFlags').checked = config.ShowAudioLanguageFlags !== false;
                    document.querySelector('#SkipItemsWithNoAudioLanguage').checked = config.SkipItemsWithNoAudioLanguage !== false;
                    document.querySelector('#ShowImdbRating').checked = config.ShowImdbRating !== false;
                    document.querySelector('#ShowRottenTomatoes').checked = config.ShowRottenTomatoes !== false;
                    document.querySelector('#BadgePosition').value = config.BadgePosition || 'BottomLeft';
                    document.querySelector('#UseLetterResolution').value = config.UseLetterResolution !== false ? 'true' : 'false';
                    document.querySelector('#UseExternalRatings').checked = config.UseExternalRatings === true;
                    document.querySelector('#MdbListApiKey').value = config.MdbListApiKey || '';
                    document.querySelector('#TmdbApiKey').value = config.TmdbApiKey || '';
                    document.querySelector('#CustomTagEnabled').checked = config.CustomTagEnabled === true;
                    document.querySelector('#CustomTagText').value = config.CustomTagText || '';
                    document.querySelector('#CustomTagPosition').value = config.CustomTagPosition || 'TopLeft';
                    document.querySelector('#TagCurvature').value = Math.min(100, Math.max(0, parseInt(config.TagCurvature, 10) || 0));
                    document.querySelector('#AutoApplyOnLibraryScan').checked = config.AutoApplyOnLibraryScan !== false;
                    document.querySelector('#ShowHDR').checked = config.ShowHDR !== false;
                    document.querySelector('#ShowDolbyAtmos').checked = config.ShowDolbyAtmos !== false;
                    document.querySelector('#ShowDtsX').checked = config.ShowDtsX !== false;
                    updateCurvatureLabel(parseInt(document.querySelector('#TagCurvature').value, 10));
                    loadLibraries(config.SelectedLibraryIds || []);
                    fetchPreviewItemAndImage();
                }
                Dashboard.hideLoadingMsg();
            }).catch(function () {
                Dashboard.hideLoadingMsg();
            });
            });
        }
        var refreshBtn = document.querySelector('#RefreshPreviewBtn');
        if (refreshBtn && typeof ApiClient !== 'undefined') {
            refreshBtn.addEventListener('click', function () {
                fetchPreviewItemAndImage();
            });
        }

        function scheduleLivePreview() {
            if (PosterTagsConfig.previewDebounce) clearTimeout(PosterTagsConfig.previewDebounce);
            PosterTagsConfig.previewDebounce = setTimeout(function () {
                PosterTagsConfig.previewDebounce = null;
                if (PosterTagsConfig.previewItemId) loadPreviewImage(true);
            }, 1200);
        }
        ['Show4K', 'ShowHD', 'ShowQuality', 'ShowAudioLanguageFlags', 'SkipItemsWithNoAudioLanguage', 'ShowImdbRating', 'ShowRottenTomatoes', 'BadgePosition', 'UseLetterResolution', 'UseExternalRatings', 'CustomTagEnabled', 'CustomTagText', 'CustomTagPosition', 'TagCurvature', 'ShowHDR', 'ShowDolbyAtmos', 'ShowDtsX'].forEach(function (id) {
            var el = document.querySelector('#' + id);
            if (el) el.addEventListener('change', scheduleLivePreview);
            if (id === 'TagCurvature') {
                var curv = document.querySelector('#TagCurvature');
                if (curv) curv.addEventListener('input', scheduleLivePreview);
            }
        });

        function updateCurvatureLabel(val) {
            var el = document.querySelector('#TagCurvatureLabel');
            if (!el) return;
            if (val <= 0) el.textContent = '0 — Rectangle';
            else if (val >= 100) el.textContent = '100 — Pill';
            else el.textContent = val + ' — Rounded';
        }
        document.querySelector('#TagCurvature').addEventListener('input', function () {
            updateCurvatureLabel(parseInt(this.value, 10));
        });

        function getLibrariesUrl() {
            var base = (window.location.origin || '').replace(/\/$/, '');
            return base + '/Plugins/PosterTags/Libraries';
        }
        function loadLibraries(selectedIds) {
            var container = document.querySelector('#LibraryCardsContainer');
            if (!container) return;
            container.innerHTML = '';
            var url = getLibrariesUrl();
            var opts = { credentials: 'include', headers: getAuthHeaders() };
            fetch(url, opts)
                .then(function (r) { return r.ok ? r.json() : Promise.reject(new Error(r.statusText)); })
                .then(function (libraries) {
                    (libraries || []).forEach(function (lib, index) {
                        var id = lib.Id || '';
                        var name = lib.Name || lib.Id || id || 'Library';
                        var label = document.createElement('label');
                        label.className = 'library-card';
                        var cb = document.createElement('input');
                        cb.type = 'checkbox';
                        cb.name = 'LibraryIds';
                        cb.value = id;
                        cb.id = 'postertags-lib-' + index;
                        cb.checked = selectedIds.indexOf(id) !== -1;
                        label.htmlFor = cb.id;
                        var span = document.createElement('span');
                        span.className = 'library-name';
                        span.textContent = name;
                        label.appendChild(cb);
                        label.appendChild(span);
                        container.appendChild(label);
                    });
                })
                .catch(function () {});
        }
        (function ensureLibrariesLoad() {
            function run() { loadLibraries([]); }
            if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', run);
            else run();
        })();

        var formEl = document.querySelector('#PosterTagsConfigForm');
        if (formEl && typeof ApiClient !== 'undefined' && typeof Dashboard !== 'undefined') {
            formEl.addEventListener('submit', function (e) {
                e.preventDefault();
                Dashboard.showLoadingMsg();
            var selectedIds = [];
            document.querySelectorAll('input[name="LibraryIds"]:checked').forEach(function (cb) { selectedIds.push(cb.value); });
            ApiClient.getPluginConfiguration(PosterTagsConfig.pluginUniqueId).then(function (config) {
                if (!config) config = {};
                config.Show4K = document.querySelector('#Show4K').checked;
                config.ShowHD = document.querySelector('#ShowHD').checked;
                config.ShowQuality = document.querySelector('#ShowQuality').checked;
                config.ShowAudioLanguageFlags = document.querySelector('#ShowAudioLanguageFlags').checked;
                config.SkipItemsWithNoAudioLanguage = document.querySelector('#SkipItemsWithNoAudioLanguage').checked;
                config.ShowImdbRating = document.querySelector('#ShowImdbRating').checked;
                config.ShowRottenTomatoes = document.querySelector('#ShowRottenTomatoes').checked;
                config.BadgePosition = document.querySelector('#BadgePosition').value || 'BottomLeft';
                config.UseLetterResolution = document.querySelector('#UseLetterResolution').value === 'true';
                config.UseExternalRatings = document.querySelector('#UseExternalRatings').checked;
                config.MdbListApiKey = (document.querySelector('#MdbListApiKey').value || '').trim();
                config.TmdbApiKey = (document.querySelector('#TmdbApiKey').value || '').trim();
                config.CustomTagEnabled = document.querySelector('#CustomTagEnabled').checked;
                config.CustomTagText = (document.querySelector('#CustomTagText').value || '').trim();
                config.CustomTagPosition = document.querySelector('#CustomTagPosition').value || 'TopLeft';
                config.TagCurvature = Math.min(100, Math.max(0, parseInt(document.querySelector('#TagCurvature').value, 10) || 0));
                config.AutoApplyOnLibraryScan = document.querySelector('#AutoApplyOnLibraryScan').checked;
                config.ShowHDR = document.querySelector('#ShowHDR').checked;
                config.ShowDolbyAtmos = document.querySelector('#ShowDolbyAtmos').checked;
                config.ShowDtsX = document.querySelector('#ShowDtsX').checked;
                config.SelectedLibraryIds = selectedIds;
                ApiClient.updatePluginConfiguration(PosterTagsConfig.pluginUniqueId, config).then(function (result) {
                    Dashboard.processPluginConfigurationUpdateResult(result);
                }).catch(function () {
                    Dashboard.hideLoadingMsg();
                });
            }).catch(function () {
                Dashboard.hideLoadingMsg();
            });
                return false;
            });
        }
    </script>
</div>
